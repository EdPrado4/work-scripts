# Sonatype Report CVE-2015-5346
By: Oscar Prado - 34edprado@gmail.com


## 1. Overview

The advisory CVE-2015-5346 reports a session fixation vulnerability
for Apache Tomcat Software.
The goal of this section is to make an overview of the vulnerability,
possible exploitation, and potential harms of a successful materialization

### The Vulnerability

A session fixation vulnerability occurs
when an attacker succeeds to obtain a session ID
that is either static or can be easily guessable.
The attacker then tricks the user into login into the application
with the same session ID,
resulting in a session takeover by the attacker.

### The Risks

A session fixation vulnerability
can lead to a session hijack,
allowing an attacker to impersonate a valid user
on the application.
By hijacking the session,
an attacker could perform actions on behalf
of the victim, for example:

- Obtain potentially sensitive information
according to the application context such as
financial information (account numbers, credit card numbers, financial movements),
personal information (Phone Numbers, Contacts, Personal ID, Physical Address) or
technical information (Roles, Keys, Access Tokens), among others.

- Modify technical or sensitive information
(such as the described in the previous point).

- Delete technical, sensitive information,
or in some cases, delete the hijacked account itself,
denying the access to the legitimate user.

Thus, potentially affecting: Confidentiality, Integrity and Availability

### The Exploitation

A session fixation vulnerability can be exploited
using different techniques.
The most common are:

- **URL Parameters:** Some applications send session tokens
via URL parameters in GET requests (which is insecure!).
This method consists in crafting a malicious URL
with the obtained session ID,
and then tricking the user to click the link
and login into the application to exploit the vulnerability.

- **Hidden Fields:** This method consists in tricking the victim
into log in to the application using a malicious form designed by the attacker.
This form can contain hidden fields that send malicious requests
that can manually set the session ID in the desired value
(similar to exploiting a [CSRF vulnerability](https://owasp.org/www-community/attacks/csrf)).

- **Session Cookies:** This method relies in the existence
of a vulnerability that allows the modification of client-side information,
such a [Cross-Site-Scripting (XSS)](https://owasp.org/www-community/attacks/xss/)
or [Man In the Browser (MitB)](https://owasp.org/www-community/attacks/Man-in-the-browser_attack).
By exploiting any of these vulnerabilities,
and as long as the session cookies
remain unprotected to client-side overwriting ([HttpOnly](https://owasp.org/www-community/HttpOnly)),
the attacker can fix the session cookie with the desired value.

## 2. Description

Now the vulnerability has been explained,
let's talk about the context in the environment
of the affected software.

### Apache Tomcat

Apache Tomcat is a popular Web Server to host Java Web Applications.
It provides useful tools to manage servlets, JSP pages and other applications.

### How is the vulnerability present in Apache Tomcat?

The vulnerability affects mainly two files:
[Coyoteadapter.java](https://github.com/apache/tomcat/blob/main/java/org/apache/catalina/connector/CoyoteAdapter.java) which implements the class `Request` and
[Request.java](https://github.com/apache/tomcat/blob/main/java/org/apache/catalina/connector/Request.java), where the vulnerability was originally located.
The first one is a middleware to communicate with [Apache Coyote](https://tomcat.apache.org/tomcat-4.1-doc/config/coyote.html), an HTTP connector
that allows Catalina (a servlets container)
to work as a standalone Web Server, execute servlets and JSP pages
while the latter is an implementation of a [Java HttpServletRequest interface](https://docs.oracle.com/javaee/6/api/index.html?javax/servlet/http/HttpServletRequest.html)
customized to be compatible with Apache Coyote.

### Vulnerability Explanation

The session fixation was produced in the file `Request.java`,
specifically in the method [`recycle()`](https://github.com/apache/tomcat/blob/main/java/org/apache/catalina/connector/Request.java#L436)
and was produced by the failure of the system
to recycle the `requestedSessionSSL` variable
when recycling the `Request` object in a new request.

If a web application was configured to use the SSL Session ID
as an HTTP Session ID,
this failure to recycle the `requestedSessionSSL` variable would
allow an attacker to control the session ID.
However, the attacker would still
need to trick the victim to log in to the vulnerable Web Server
to gain control over the session.
Built-in features such as [parallel deployment](https://tomcat.apache.org/tomcat-9.0-doc/config/context.html#Parallel_deployment)
can be used to achieve a successful exploitation.

## 3. Vulnerable Commit

The vulnerability was introduced with the addition
of the `recycle()` method in the `Request.java` file.
Since this file already had the vulnerable method on its first version,
and the file was present in the creation of the repository,
we can track the vulnerable commit to the [initial commit](https://github.com/apache/tomcat/commit/a84fabcbc6fee8a69253ad92a304b4718e96a7c9)
(`a84fabcbc6fee8a69253ad92a304b4718e96a7c9`).


## 4. Vulnerable versions

Apache Tomcat currently has 4 major releases,
which are presented as branches in the repository:
`7.0.x`, `8.5.x`, `9.0.x` and `10.0.x`.

The goal of this section is to present
the version or range of versions that are affected by the vulnerability,
alongside with the Artifact ID and Group ID,
taken from the Maven central repositories

### Apache Tomcat 7.0.x

- **Group ID:** `org.apache.tomcat`
- **Artifact ID:** `tomcat-catalina`
- **Vulnerable versions:** `7.0.0` to `7.0.65`

### Apache Tomcat 8.0.x

- **Group ID:** `org.apache.tomcat`
- **Artifact ID:** `tomcat-catalina`
- **Vulnerable versions:** `8.0.0-RC1` to `8.0.30`

### Apache Tomcat 9.0.x

- **Group ID:** `org.apache.tomcat`
- **Artifact ID:** `tomcat-catalina`
- **Vulnerable version:** `9.0.0.M1`

### Apache Tomcat 10.0.x

This version was not affected by CVE-2015-5346.

## 5. Remediation

The remediation for this vulnerability
consists in properly recycling the SSL session
by setting the variable `requestedSessionSSL` in `false`
when recycling a request.
To this end, a new void method named `recycleSessionInfo()`
was created, as a separate method,
merging other common cleanups for a correct session recycling.


### Apache Tomcat 7.0.X

For Apache Tomcat 7.0.x the vulnerability was solved in the following [commit:](https://github.com/apache/tomcat/commit/6287be37d8d06c320215c45f7e2b8380411692e0) `6287be37d8d06c320215c45f7e2b8380411692e0`

### Apache Tomcat 8.0.X

For Apache Tomcat 8.0.x and 8.5.x the vulnerability was solved
in the following commits:
- [Part 1:](https://github.com/apache/tomcat/commit/f58aa9f5273e08c56389af344910302b7c078321)
 `f58aa9f5273e08c56389af344910302b7c078321`.
- [Part 2:](https://github.com/apache/tomcat/commit/0dd9e7811a06e0e131da734eb706a1db4a77119c)
`0dd9e7811a06e0e131da734eb706a1db4a77119c`.

### Apache Tomcat 9.0.X

For Apache Tomcat 9.0.x the vulnerability was fixed in the following commits:

- [Part 1:](https://github.com/apache/tomcat/commit/83679b99cd40caa401d173c8f8e72fc98eb5d5be)
 `83679b99cd40caa401d173c8f8e72fc98eb5d5be`.
- [Part 2](https://github.com/apache/tomcat/commit/04164c1f01b973e548d95511d417f414ca723cb8)
 `04164c1f01b973e548d95511d417f414ca723cb8`.

### Apache Tomcat 10.0.X

This version was already fixed against CVE-2015-5346.

## 6. Recommendation and final thoughts

If you use Apache Tomcat as a part of your technology stack
consider upgrading your software to avoid this vulnerability.
The **latest stable version** is always recommended,
since generally it's the most secure version
and patches most known bugs and vulnerabilities,
however, for legacy systems upgrading components may result
in a [dependency hell](https://about.sourcegraph.com/blog/nine-circles-of-dependency-hell/)
if that's your case, take the following considerations
to avoid a session fixation attack:

- Upgrade to version `7.0.67` or higher if you're using `7.0.x` version.
- Upgrade to version `8.0.32` or higher if you're using `8.0.x` version.
- Upgrade to version `9.0.0.M3` or higher if you're using `9.0.x` version.


## 7. References

1. [CVE-2015-5346 Mitre Advisory](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2015-5346)
1. [OWASP Session Fixation](https://owasp.org/www-community/attacks/Session_fixation)
1. [OWASP CSRF](https://owasp.org/www-community/attacks/csrf)
1. [OWASP Cross Site Scripting](https://owasp.org/www-community/attacks/xss)
1. [OWASP Man in the Browser](https://owasp.org/www-community/attacks/Man-in-the-browser_attack)
1. [OWASP HttpOnly](https://owasp.org/www-community/HttpOnly)
1. [Apache Revision for 9.0.x version](https://svn.apache.org/viewvc?view=revision&revision=1713184)
1. [Apache Revision for 8.0.x and 8.5.x version](https://svn.apache.org/viewvc?view=revision&revision=1713185)
1. [Apache Revision for 7.0.x version](https://svn.apache.org/viewvc?view=revision&revision=1713187)
1. [Apache Tomcat 7.0.x Vulnerabilities](https://tomcat.apache.org/security-7.html)
1. [Apache Tomcat 8.0.x Vulnerabilities](https://tomcat.apache.org/security-8.html)
1. [Apache Tomcat 9.0.x Vulnerabilities](https://tomcat.apache.org/security-9.html)
1. [Bugzilla Review](https://bz.apache.org/bugzilla/show_bug.cgi?id=58809)
1. [Apache Coyote](https://tomcat.apache.org/tomcat-4.1-doc/config/coyote.html)
1. [Dependency Hell](https://about.sourcegraph.com/blog/nine-circles-of-dependency-hell/)